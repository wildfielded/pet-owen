## Рефакторинг старого ПО (Visual Basic) на новый стек (Python) ##
### Исходное задание ###
- На сервере ПО OWEN собирает телеметрию с датчиков. Некоторые температурные
показания сбрасываются в файл проприетарного формата OPR. Этот файл забирает
VB-программа на единственную рабочую станцию дежурного персонала и выводит в
отдельном окне с интервалом обновления около 20с.    
- Для каждого измерения есть два пороговых значения для отображения цветового
предупреждения (yellow, red) и звуковой сигнализации, которые также хранятся в
отдельном конфигурационном файле, где можно изменять пороги.    
- В графике отображается история измерений за определённый интервал времени
(например, за последний час) - некий аналог графиков в MRTG.    
- Теперь надо ту же информацию выводить в окне браузера (чтобы можно было смотреть
с нескольких рабочих станций) без необходимости установки излишнего ПО (VB-soft
и некоторые модули от MS Access). С алертами и музыкой =)    
### Динамическое (постепенно меняющееся) ТЗ ###
1. Забрать по SMB/CIFS текстовый файл в кодировке UTF-8 (но иногда при отладке
нового функционала программы файлы идут в старой Windows-1251), в котором
построчно (для каждого датчика) 4 поля, разделённых табами: EventDate (дата),
EventTime (время), Description (место датчика), Value (температура).    
2. Забрать по SMB/CIFS текстовый файл в кодировке Windows-1251, (сейчас уже изменили
на UTF-8) в котором построчно (для каждого датчика) 3 поля, разделённые табами:
Description (место датчика), Max1 ("жёлтый" порог температуры), Max2 ("красный"
порог температуры).    
3. Поступившие данные надо распарсить, выдать текущую температуру на web-page и
сохранить в истории.    
4. В истории хранить данные за определённый интервал времени (типовое значение -
1 час). Устаревшие данные удалять.    
5. Если показания датчика достигают пороговых значений, на web-page должны
происходить соответствующие раскраски. Появояются дополнительные строки таблицы
или поля ниже таблицы (как вариант - может вылетать модальное окно) с кнопками
квитирования, плюс проигрываться страшные звуки тревоги (которые прекращаются по
нажатию кнопки).    
6. Датчики иногда сбоят и если нет данных больше минуты, то вместо цифр в файл
выдаётся **`"?"`**. Также сама программа иногда вылетает и перестаёт обновлять
файл на шаре. По этим случаям также предусмотреть аудиовизуальные алерты.
- [**Proof of Concept**](https://github.com/wildfielded/pet-owen/tree/master/PoC)
создаётся на стеке Python3.8/Apache/Ubuntu. Соответственно, на Ubuntu помимо пакета
**`apache2`** требуется установка **`pipenv`** и потом из хранилища PyPI установка
**`PySMB`** и **`PyPNG`**.    
Поскольку всё происходит в среде Microsoft AD со строгими политиками, доступных
без авторизации сетевых шар нет. Поэтому рекомендуется создание отдельной
сервисной учётки для доступа куда надо.    
#### Done (что сделано) ####
- Забираем файлы измерений и порогов с сетевого ресурса к себе. При этом идёт
проверка наличия файлов и "свежесть" файла измерений (должен быть не старее
2 минут). В случаях отсутствия или критичной "протухлости" вместо таблицы
выдаётся соответствующее сообщение.    
- Обработка случаев "разнобоя" с кодировками файлов данных и пороговых значений.    
- Обработка случаев с знаком **`"?"`** и других непонятных ошибок чтения данных.    
- Обработка превышений пороговых значений.    
- Генерилка простенького HTML c автообновлением. Выдача в таблицу местоположения
датчиков и температуры. Раскраска ячеек с текущими показаниями по статусу:
**green / yellow / red / gray / black**.    
- Обработка ошибок через **`try/except/else/finally`**.    
- Простенькое логирование по сети через **`syslog`**. Поскольку проект работает
на версии python-3.8.10, там не так много возможностей настройки (как в версии 3.10),
но и этого вполне достаточно для отладки и мониторинга.    
- Хранение истории измерений без привлечения каких-либо БД, обошлись форматом JSON.    
- История в графическом виде. Разные numpy, matplotlib, etc. - это, конечно,
замечательно, но пока обошлось установкой из хранилища PyPI простецкого **`PyPNG`**.
Реализована четырёхцветная палитра для расцвечивания превышений порогов.    
- Звуковая сигнализация срабатывает при возникновении события перехода через
пороговое значения и при следующем измерении уже не кричит (только когда пройден
ещё какой-нибудь порог). Изначально сирена воет один раз и недолго. Но для
выбешивания дежурного персонала можно в файле **`script.js`** выставить **loopPlaying**
так, чтобы рёв был до тех пор, пока не нажата кнопка на странице.
- Работает на Ubuntu-сервере с Apache.    
#### Добавки ####
[**`.ADDS`**](https://github.com/wildfielded/pet-owen/tree/master/.ADDS) - дополнительные
вещи и телодвижения для деплоя.    
#### Doing (ближайшие планы) ####
- Улучшайзинг кода после каждого фиченаворотинга (на постоянной основе). То есть
делать код более оптимальным и читабельным по мере прокачки экспы.    
- Модальные окна выводить с помощью JavaScript.    
- Также с помощью JavaScript открывать скрытые текстовые алерты.    
#### ToDo (прекрасные мечты) ####
- Нормальная генерилка HTML.    
- Перевести всё в десктопное приложение, без участия вэб-сервера.    
